<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>



    <style>
        /* Existing styles remain the same */
        .navbar {

            background-color: #1B4D3E !important;
            height: 55px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        
        .navbar .nav-link,
        .navbar .navbar-brand {
            color: white !important;
        }
        .navbar .nav-link:hover {
            color: #f8f9fa !important;
        }

        body {
            display: flex;
        }
        .sidebar {
            width: 300px;
            height:fill;
            min-height: 95vh;
            background:#ebf2f0;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .sidebar a {
    display: block;
    padding: 20px 20px;
    text-decoration: none;
    color: black;
    font-weight: bold;
}
/* 
.sidebar a:hover {
    background-color: #1B4D3E;
    color: white;
} */

/* Style for Active Sidebar Link */
.sidebar a.active {
    background-color: #1B4D3E;
    color: white;
}


        .content {
            flex-grow: 1;
            padding: 20px;
        }

    /* New styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .plan-form {
            max-width: 500px;
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .plan-form input, .plan-form select {
            margin-bottom: 15px;
        }
.list-group-item.active {
    background-color: #1B4D3E;
    border-color: #1B4D3E;
}

.list-group-item:hover {
    background-color: #e9ecef;
}

.plan-form {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background-color: #fff;
}



.subscriber-card {
    background: #ebf2f0; /* âœ… Matches Requested Format */
    padding: 20px;
    text-align: center;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.subscriber-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.subscriber-card i {
    font-size: 30px;
    margin-bottom: 10px;
    color: #1B4D3E;
}

.subscriber-card h4 {
    color: #1B4D3E; 
}

    /* Existing styles remain unchanged */
    /* ... */

    /* Modal Styling */
    .notify-modal .modal-content {
        border-radius: 8px;
    }
    .notify-modal .modal-header {
        background-color: #1B4D3E;
        color: white;
    }
    .notify-modal .modal-body {
        padding: 20px;
    }
    .notify-modal textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
    }
    .notify-all-btn {
        background-color: #1B4D3E;
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        border: none;
        margin-bottom: 20px;
    }
    .notify-all-btn:hover {
        background-color: #145c3a;
    }


    .dataTables_wrapper .dataTables_filter {
    float: right;
    margin-bottom: 15px;
}

.dataTables_wrapper .dataTables_filter input {
    border: 1px solid #1B4D3E;
    transition: border-color 0.3s;
}

.dataTables_wrapper .dataTables_filter input:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
}

.dataTables_wrapper .dataTables_length {
    float: left;
    margin-bottom: 15px;
}

.dataTables_wrapper .dataTables_paginate {
    margin-top: 15px;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
    margin: 0 2px;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.active .page-link {
    background-color: #1B4D3E;
    border-color: #1B4D3E;
    color: white;
}

.dataTables_wrapper .dataTables_paginate .page-link {
    color: #1B4D3E;
}

.dataTables_wrapper .dataTables_paginate .page-link:hover {
    background-color: #ebf2f0;
    border-color: #1B4D3E;
}

#userDetailsContent p {
    margin-bottom: 10px;
    font-size: 16px;
}

#userDetailsContent strong {
    display: inline-block;
    width: 120px;
    color: #1B4D3E;
}

#rechargeHistoryTable {
    margin-top: 15px;
}

</style>

</head>

<body>

    <!-- Navbar remains the same -->
    <div class="navbar navbar-expand-md fixed-top">
        <div class="container-fluid">
            <a href="admin.html" class="navbar-brand ms-4">
                <img src="images/prezee2.png" style="width: 50px;">
            </a>

            <a href="Dashboard copy 2.html" download="Report.pdf" style="margin-left: 1250px; padding-top: 15px;"><b><i class="bi bi-download text-white fs-5"></i></b></a>              
            <a href="#" class="nav-link">
                <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#links">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div id="links" class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="#" class="nav-link me-5">
                                <i class="bi bi-person-circle text-white fs-5"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    <!-- Sidebar -->
    
    <div class="sidebar" style="margin-top: 50px; margin-right: 30px; padding-top: 50px;padding-left: 20px;">
        <a href="#" class="active" onclick="setActive(this); loadDashboard()">
            <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="#" onclick="setActive(this); loadSubscriberManagement()">
            <i class="fas fa-user-check"></i> Subscriber Management
        </a>
        <a href="#" onclick="setActive(this); loadPlanManagement()">
            <i class="fas fa-file-invoice"></i> Plan Management
        </a>
        <a href="#" onclick="setActive(this); loadReportAnalysis()">
            <i class="fas fa-chart-pie"></i> Report & Analysis
        </a>
        <a href="#" onclick="setActive(this); handleLogout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
    
    

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Notify Modal -->
<div id="notifyModal" class="modal fade notify-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notify Subscriber</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="notifyEmail" class="form-control" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Message</label>
                    <textarea id="notifyMessage" class="form-control">Your Plan is About to Expire</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="sendNotification()">
                    <i class="bi bi-send-fill"></i> Send
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Notify All Modal -->
<div id="notifyAllModal" class="modal fade notify-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notify All Expiring Subscribers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Message</label>
                    <textarea id="notifyAllMessage" class="form-control">Your Plan is About to Expire</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="sendAllNotifications()">
                    <i class="bi bi-send-fill"></i> Send
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1B4D3E; color: white;">
                <h5 class="modal-title">Subscriber Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent" class="row">
                    <!-- User details will be injected here -->
                </div>
                <hr>
                <h6>Recharge History</h6>
                <table class="table table-bordered" id="rechargeHistoryTable">
                    <thead>
                        <tr>
                            <th>Plan Name</th>
                            <th>Date</th>
                            <th>Payment Type</th>
                        </tr>
                    </thead>
                    <tbody id="rechargeHistoryBody">
                        <!-- Recharge history will be injected here -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Main Content Area -->
    <div class="content" id="main-content" style="margin-top: 60px;">
        <!-- Content will be loaded dynamically -->
    </div>

    <script>


 // for dashboard
 function loadDashboard() {
    const totalPlans = Object.values(plansData).reduce((acc, curr) => acc + curr.length, 0);
    const totalSubscribers = usersData.length;
    const expiringUsers = getExpiringUsers(3).slice(0, 2);

    // Count active and inactive users
    const activeUsers = usersData.filter(user => user.status.toLowerCase() === 'active').length;
    const inactiveUsers = totalSubscribers - activeUsers;

    // Prepare month-wise user growth data
    const monthlyGrowth = {};
    usersData.forEach(user => {
        user.rechargeHistory.forEach(recharge => {
            const month = recharge.date.slice(0, 7); // Extract YYYY-MM
            monthlyGrowth[month] = (monthlyGrowth[month] || 0) + 1;
        });
    });

    const months = Object.keys(monthlyGrowth).sort();
    const userCounts = months.map(month => monthlyGrowth[month]);

    // Inject HTML
    document.getElementById('main-content').innerHTML = `
       <h2 class="ms-4 mb-4 mt-3" style="color: #1B4D3E">Dashboard</h2>
  <div class="row mt-4">
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="subscriber-card">
            <i class="fa-solid fa-file-alt"></i>
            <h4>Total Plans</h4>
            <p class="h2" style="color: #1B4D3E">${totalPlans}</p>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="subscriber-card">
            <i class="fa-solid fa-users"></i>
            <h4>Total Customers</h4>
            <p class="h2" style="color: #1B4D3E">${totalSubscribers}</p>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="subscriber-card">
            <i class="fa-solid fa-chart-line"></i>            
            <h4>Total Revenue</h4>
            <p class="h2" style="color: #1B4D3E">â‚¹${calculateTotalRevenue()}</p>
        </div>
    </div>
</div>

    
    <h3 class="ms-4 mb-4 mt-5" style="color: #1B4D3E">Subscribers Expiring Soon</h3>
<table class="table table-bordered ms-3">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Plan Details</th>
            <th>Expiry Date</th>
            <th>
                Action
            </th>
        </tr>
    </thead>
    <tbody>
        ${expiringUsers.map(user => `
            <tr>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${getPlanDetails(user.plan_id)}</td>
                <td>${formatDate(user.expiry)}</td>
                <td>
                    <button class="btn btn-sm" style="background-color:#1B4D3E; color:white; border-radius:10px; padding:5px 15px; border:none;" 
                                    onclick="showUserDetails('${user.email}')">
                                <i class="bi bi-eye-fill"></i> View
                    </button>
                </td>
            </tr>
        `).join('')}
    </tbody>
</table>

    <div class="row mt-5 ms-3 pt-3">
        <div class="col-md-6 d-flex flex-column align-items-center">
            <h3 class="mb-3">Users grouth</h3>
            <canvas id="userGrowthChart" style="max-width: 500px; max-height: 300px;"></canvas>
        </div>
        <div class="col-md-6 d-flex flex-column align-items-center">
            <h3 class="mb-3">Active vs Inactive Users</h3>
            <canvas id="userPieChart" style="max-width: 400px; max-height: 300px;"></canvas>
        </div>
    </div>
    `;


    // Render Line Chart for User Growth
    const ctxLine = document.getElementById('userGrowthChart').getContext('2d');
    new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'User Growth',
                data: userCounts,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: 'Month' } },
                y: { title: { display: true, text: 'Expiring Users' }, beginAtZero: true }
            }
        }
    });

    // Render Pie Chart
    const ctxPie = document.getElementById('userPieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: ['Active Users', 'Inactive Users'],
            datasets: [{
                data: [activeUsers, inactiveUsers],
                backgroundColor: ['#28a745', '#dc3545'], // Green & Red
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    
}




        let currentPage = 1;
const pageSize = 4; // Change this value to show more/less users per page
let currentSubscriberPage = 1;
const subscribersPerPage = 5;



function setActive(element) {
    // Remove 'active' class from all sidebar links
    document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));

    // Add 'active' class to the clicked link
    element.classList.add('active');
}

        // Load and store JSON data
        let plansData = {};
        let usersData = [];

        Promise.all([
            fetch('/Version1-Mobi-com(Pre-Zee)/Json_files/plans.json').then(res => res.json()),
            fetch('/Version1-Mobi-com(Pre-Zee)/Json_files/user.json').then(res => res.json())
        ]).then(([plans, users]) => {
            plansData = plans;
            usersData = users;
            loadDashboard(); // Initial load
        });

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function loadSubscriberManagement() {
    const activeSubscribers = usersData.filter(user => user.status.toLowerCase() === 'active');
    const inactiveSubscribers = usersData.filter(user => user.status.toLowerCase() === 'inactive');
    const expiringSubscribers = getExpiringUsers(3);

    document.getElementById('main-content').innerHTML = `
        <h2 class="mb-4 mt-4 pb-2" style="color: #1B4D3E">Subscriber Management</h2>
        <div class="row"> 
            <div class="col-md-3">
                <div class="subscriber-card" onclick="showSubscriberList('active')">
                    <i class="bi bi-person-check-fill" style="font-size: 2rem; color: #28a745;"></i>
                    <h4>Active Subscribers</h4>
                    <p class="h2">${activeSubscribers.length}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subscriber-card" onclick="showSubscriberList('inactive')">
                    <i class="bi bi-person-dash-fill" style="font-size: 2rem; color: #dc3545;"></i>
                    <h4>Inactive Subscribers</h4>
                    <p class="h2">${inactiveSubscribers.length}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subscriber-card" onclick="showSubscriberList('expiring')">
                    <i class="bi bi-hourglass-split" style="font-size: 2rem; color: #ffc107;"></i>
                    <h4>Expiring Soon</h4>
                    <p class="h2">${expiringSubscribers.length}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subscriber-card" onclick="showSubscriberList('all')">
                    <i class="bi bi-people-fill" style="font-size: 2rem; color: #0d6efd;"></i>
                    <h4>All Subscribers</h4>
                    <p class="h2">${usersData.length}</p>
                </div>
            </div>
        </div>
        <div id="subscriber-list" style="margin-top:40px"></div>
    `;

    showSubscriberList('active');
}

function showSubscriberList(type) {
    let subscribers, title, showNotifyColumn = false;

    switch (type) {
        case 'active':
            subscribers = usersData.filter(user => user.status.toLowerCase() === 'active');
            title = 'Active Subscribers';
            break;
        case 'inactive':
            subscribers = usersData.filter(user => user.status.toLowerCase() === 'inactive');
            title = 'Inactive Subscribers';
            break;
        case 'expiring':
            subscribers = getExpiringUsers(3);
            title = 'Expiring Soon';
            showNotifyColumn = true;
            break;
        default:
            subscribers = usersData;
            title = 'All Subscribers';
    }

    let notifyAllButton = '';
    if (showNotifyColumn) {
        notifyAllButton = `<button class="notify-all-btn mb-3" onclick="showNotifyAllModal()">Notify All</button>`;
    }

    document.getElementById('subscriber-list').innerHTML = `
        <h3 class="mt-5 mb-4 pb-2" style="color: #1B4D3E">${title}</h3>
        ${notifyAllButton}
        <table id="subscriberTable" class="table table-bordered table-hover" style="width:100%">
            <thead style="color: #1B4D3E; background-color: #ebf2f0;">
                <tr>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Email</th>
                    <th>Plan Details</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Action</th>
                    ${showNotifyColumn ? '<th>Notify</th>' : ''}
                </tr>
            </thead>
            <tbody>
                ${subscribers.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.mobile}</td>
                        <td>${user.email}</td>
                        <td>${getPlanDetails(user.plan_id)}</td>
                        <td>${formatDate(user.expiry)}</td>
                        <td>
                            <span class="badge ${user.status.toLowerCase() === 'active' ? 'bg-success' : 'bg-danger'}">
                                ${user.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm" style="background-color:#1B4D3E; color:white; border-radius:10px; padding:5px 15px; border:none;" 
                                    onclick="showUserDetails('${user.email}')">
                                <i class="bi bi-eye-fill"></i> View
                            </button>
                        </td>
                        ${showNotifyColumn ? `
                            <td>
                                <button class="btn btn-sm" style="background-color:#ffc107; color:white; border-radius:10px; padding:5px 15px; border:none;" 
                                        onclick="showNotifyModal('${user.email}')">
                                    <i class="bi bi-bell-fill"></i> Notify
                                </button>
                            </td>
                        ` : ''}
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    // Destroy existing DataTable if it exists
    if ($.fn.DataTable.isDataTable('#subscriberTable')) {
        $('#subscriberTable').DataTable().destroy();
    }

    // Initialize DataTable with pagination and search
    $('#subscriberTable').DataTable({
        responsive: true,
        pageLength: 5,
        lengthMenu: [[5, 10, 25, 50], [5, 10, 25, 50]],
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        language: {
            search: "",
            searchPlaceholder: "Search subscribers...",
            emptyTable: "No subscribers found",
            info: "Showing _START_ to _END_ of _TOTAL_ subscribers",
            infoEmpty: "Showing 0 to 0 of 0 subscribers",
            lengthMenu: "Show _MENU_ subscribers per page",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        columnDefs: [
            { orderable: false, targets: -1 }
        ],
        dom: '<"row mb-3"<"col-md-6"l><"col-md-6"f>>t<"row mt-3"<"col-md-6"i><"col-md-6"p>>'
    });

    // Style the search input and pagination
    $('.dataTables_filter input').addClass('form-control').css({
        'width': '300px',
        'margin-left': 'auto',
        'display': 'block',
        'border-radius': '20px',
        'padding': '8px 15px'
    });

    $('.dataTables_paginate').addClass('pagination').find('a').addClass('page-link');
    $('.dataTables_paginate .paginate_button').addClass('page-item');
    $('.dataTables_paginate .paginate_button.current').addClass('active');
}

let currentEmail = '';
function showNotifyModal(email) {
    currentEmail = email;
    document.getElementById('notifyEmail').value = email;
    document.getElementById('notifyMessage').value = 'Your Plan is About to Expire';
    new bootstrap.Modal(document.getElementById('notifyModal')).show();
}

function sendNotification() {
    const email = currentEmail;
    const message = document.getElementById('notifyMessage').value;
    showToast(`Notification sent to ${email}`, 'success');
    console.log(`Sending to ${email}: ${message}`);

    // Show success tick
    const modalBody = document.querySelector('#notifyModal .modal-body');
    modalBody.innerHTML = `
        <div class="text-center">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <p class="mt-3">Notification sent successfully to ${email}</p>
        </div>
    `;
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('notifyModal')).hide();
        modalBody.innerHTML = `
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="notifyEmail" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea id="notifyMessage" class="form-control">Your Plan is About to Expire</textarea>
            </div>
        `;
    }, 2000); // Show tick for 2 seconds
}

function showNotifyAllModal() {
    document.getElementById('notifyAllMessage').value = 'Your Plan is About to Expire';
    new bootstrap.Modal(document.getElementById('notifyAllModal')).show();
}

function sendAllNotifications() {
    const message = document.getElementById('notifyAllMessage').value;
    const expiringSubscribers = getExpiringUsers(3);
    expiringSubscribers.forEach(user => {
        console.log(`Sending to ${user.email}: ${message}`);
    });
    showToast(`Notifications sent to ${expiringSubscribers.length} subscribers`, 'success');

    // Show success tick
    const modalBody = document.querySelector('#notifyAllModal .modal-body');
    modalBody.innerHTML = `
        <div class="text-center">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <p class="mt-3">Notifications sent successfully to ${expiringSubscribers.length} subscribers</p>
        </div>
    `;
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('notifyAllModal')).hide();
        modalBody.innerHTML = `
            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea id="notifyAllMessage" class="form-control">Your Plan is About to Expire</textarea>
            </div>
        `;
    }, 2000); // Show tick for 2 seconds
}

function showUserDetails(email) {
    const user = usersData.find(u => u.email === email);
    if (!user) {
        showToast('User not found', 'error');
        return;
    }

    document.getElementById('userDetailsContent').innerHTML = `
        <div class="col-md-6">
            <p><strong>Name:</strong> ${user.name}</p>
            <p><strong>Mobile:</strong> ${user.mobile}</p>
            <p><strong>Email:</strong> ${user.email}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Plan ID:</strong> ${user.plan_id}</p>
            <p><strong>Plan Details:</strong> ${getPlanDetails(user.plan_id)}</p>
            <p><strong>Expiry Date:</strong> ${formatDate(user.expiry)}</p>
            <p><strong>Status:</strong> 
                <span class="badge ${user.status.toLowerCase() === 'active' ? 'bg-success' : 'bg-danger'}">
                    ${user.status}
                </span>
            </p>
        </div>
    `;

    document.getElementById('rechargeHistoryBody').innerHTML = user.rechargeHistory.map(recharge => `
        <tr>
            <td>${recharge.planName}</td>
            <td>${formatDate(recharge.date)}</td>
            <td>${recharge.paymentType}</td>
        </tr>
    `).join('');

    new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
}


function loadPlanManagement() {
    const categories = Object.keys(plansData);
    document.getElementById('main-content').innerHTML = `
        <h2 class="mb-5 mt-4" style="color: #1B4D3E">Plan Management</h2>
        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-success" onclick="showAddCategoryModal()">
                <i class="bi bi-plus-circle"></i> Add Plan Category
            </button>
        </div>
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="list-group" id="categoryList">
                    ${categories.map(category => `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="showPlansForCategory('${category}')">${category}</a>
                    `).join('')}
                </div>
            </div>
            <div class="col-md-9">
                <div id="plansList"></div>
            </div>
        </div>

        <!-- Modal for Adding Category -->
        <div id="categoryModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Plan Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Enter Category Name:</label>
                        <input type="text" id="newCategoryName" class="form-control" required>
                        <small class="text-danger" id="categoryError" style="display:none;">Category already exists!</small>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="handleAddCategory()">Add Category</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (plansData.hasOwnProperty('Popular')) {
        showPlansForCategory('Popular');
    } else if (categories.length > 0) {
        showPlansForCategory(categories[0]);
    }
}

function showAddCategoryModal() {
    document.getElementById('newCategoryName').value = '';
    document.getElementById('categoryError').style.display = 'none';
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

function handleAddCategory() {
    const newCategory = document.getElementById('newCategoryName').value.trim();
    
    if (!newCategory) {
        showToast('Category name cannot be empty!', 'error');
        return;
    }

    // Case-insensitive check for existing category
    const existingCategories = Object.keys(plansData).map(cat => cat.toLowerCase());
    if (existingCategories.includes(newCategory.toLowerCase())) {
        document.getElementById('categoryError').style.display = 'block';
        return;
    }

    plansData[newCategory] = [];
    showToast(`Category "${newCategory}" added successfully!`, 'success');
    bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
    updateCategoryList();
}

function updateCategoryList() {
    const categoryList = document.getElementById('categoryList');
    categoryList.innerHTML = Object.keys(plansData).map(category => `
        <a href="#" class="list-group-item list-group-item-action" 
           onclick="showPlansForCategory('${category}')">${category}</a>
    `).join('');
}

function showPlansForCategory(category) {
    const plans = plansData[category];
    document.getElementById('plansList').innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>${category}</h3>
            <button class="btn btn-success" onclick="showAddPlanForm('${category}')">
                <i class="bi bi-plus-circle"></i> Add Plan
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Plan ID</th>
                        <th>Name</th>
                        <th>Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${plans.map(plan => `
                        <tr>
                            <td>${plan.plan_id}</td>
                            <td>${plan.name}</td>
                            <td>${plan.details}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="showEditPlanForm('${category}', '${plan.plan_id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeletePlan('${category}', '${plan.plan_id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;
}

function showAddPlanForm(category) {
    document.getElementById('plansList').innerHTML = `
        <div class="plan-form">
            <h3>Add New Plan to ${category}</h3>
            <form onsubmit="handleAddPlan(event, '${category}')">
                <div class="mb-3">
                    <label class="form-label">Plan ID</label>
                    <input type="text" class="form-control" name="plan_id" required>
                    <small class="text-danger" id="planIdError" style="display:none;">Plan ID already exists!</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Plan Name</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Plan Details</label>
                    <input type="text" class="form-control" name="details" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">Add Plan</button>
                    <button type="button" class="btn btn-secondary" onclick="showPlansForCategory('${category}')">Cancel</button>
                </div>
            </form>
        </div>`;
}

function showEditPlanForm(category, planId) {
    const plan = plansData[category].find(p => p.plan_id === planId);
    if (!plan) {
        showToast('Plan not found', 'error');
        return;
    }

    document.getElementById('plansList').innerHTML = `
        <div class="plan-form">
            <h3>Edit Plan</h3>
            <form onsubmit="handleEditPlan(event, '${category}', '${planId}')">
                <div class="mb-3">
                    <label class="form-label">Plan ID</label>
                    <input type="text" class="form-control" name="plan_id" value="${planId}" required>
                    <small class="text-danger" id="planIdError" style="display:none;">Plan ID already exists!</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Plan Name</label>
                    <input type="text" class="form-control" name="name" value="${plan.name}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Plan Details</label>
                    <input type="text" class="form-control" name="details" value="${plan.details}" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="showPlansForCategory('${category}')">Cancel</button>
                </div>
            </form>
        </div>`;
}

function handleAddPlan(event, category) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const newPlan = {
        plan_id: formData.get('plan_id').trim(),
        name: formData.get('name').trim(),
        details: formData.get('details').trim()
    };

    // Check if any field is empty
    if (!newPlan.plan_id || !newPlan.name || !newPlan.details) {
        showToast('All fields are required!', 'error');
        return;
    }

    // Check if plan ID already exists
    const planExists = Object.values(plansData).some(plans => 
        plans.some(plan => plan.plan_id.toLowerCase() === newPlan.plan_id.toLowerCase())
    );

    if (planExists) {
        document.getElementById('planIdError').style.display = 'block';
        return;
    }

    plansData[category].push(newPlan);
    showToast('Plan added successfully!', 'success');
    showPlansForCategory(category);
}

function handleEditPlan(event, category, planId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const updatedPlan = {
        plan_id: formData.get('plan_id').trim(),
        name: formData.get('name').trim(),
        details: formData.get('details').trim()
    };

    // Check if any field is empty
    if (!updatedPlan.plan_id || !updatedPlan.name || !updatedPlan.details) {
        showToast('All fields are required!', 'error');
        return;
    }

    const planIndex = plansData[category].findIndex(p => p.plan_id === planId);
    if (planIndex === -1) {
        showToast('Plan not found', 'error');
        return;
    }

    // Check if the new plan ID already exists elsewhere (case insensitive), excluding the current plan
    const planExistsElsewhere = Object.entries(plansData).some(([cat, plans]) => 
        cat !== category && plans.some(plan => plan.plan_id.toLowerCase() === updatedPlan.plan_id.toLowerCase())
    ) || (plansData[category].some((plan, idx) => 
        idx !== planIndex && plan.plan_id.toLowerCase() === updatedPlan.plan_id.toLowerCase())
    );

    if (planExistsElsewhere) {
        document.getElementById('planIdError').style.display = 'block';
        return;
    }

    // Update the plan
    plansData[category][planIndex] = updatedPlan;
    showToast('Plan updated successfully!', 'success');
    showPlansForCategory(category);
}

function confirmDeletePlan(category, planId) {
    if (confirm('Are you sure you want to delete this plan?')) {
        const planIndex = plansData[category].findIndex(p => p.plan_id === planId);
        
        if (planIndex === -1) {
            showToast('Plan not found', 'error');
            return;
        }

        plansData[category].splice(planIndex, 1);
        showToast('Plan deleted successfully!', 'success');
        showPlansForCategory(category);
    }
}


//for Report and analysis
function loadReportAnalysis() {
    const expiringUsers = getExpiringUsers(3);
    const planCategories = Object.keys(plansData);

    // Get plan distribution count
    const planCounts = planCategories.map(category => ({
        category,
        count: plansData[category].length
    }));

    // Generate income data per plan category
    const incomeData = {};
    usersData.forEach(user => {
        user.rechargeHistory.forEach(recharge => {
            if (!incomeData[recharge.planName]) {
                incomeData[recharge.planName] = 0;
            }
            incomeData[recharge.planName] += 100; // Assume each recharge is â‚¹100
        });
    });

    // Prepare data for income line chart
    const incomeLabels = Object.keys(incomeData);
    const incomeValues = Object.values(incomeData);

    // Count payment method usage
    const paymentMethods = { "UPI": 0, "Debit Card": 0, "Credit Card": 0 };
    usersData.forEach(user => {
        user.rechargeHistory.forEach(recharge => {
            if (paymentMethods[recharge.paymentType] !== undefined) {
                paymentMethods[recharge.paymentType]++;
            }
        });
    });

    // Log data to check if paymentMethods has values
    console.log("Payment Methods Data:", paymentMethods);

    document.getElementById('main-content').innerHTML = `
        <h2 class="mb-5 mt-4" style="color: #1B4D3E">Report & Analysis</h2>
        
        <h3 class="pb-4" style="color: #1B4D3E">Users with Expiring Plans (Next 3 Days)</h3>
        <table class="table table-bordered mb-4">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Email</th>
                    <th>Plan Details</th>
                    <th>Expiry Date</th>
                </tr>
            </thead>
            <tbody>
                ${expiringUsers.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.mobile}</td>
                        <td>${user.email}</td>
                        <td>${getPlanDetails(user.plan_id)}</td>
                        <td>${formatDate(user.expiry)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>

        <div class="row">
            <!-- Plans Distribution Chart -->
            <div class="col-md-6">
                <h3 class="mt-5 ms-4 mb-3" style="color: #1B4D3E">Plans Distribution</h3>
                <div style="height: 350px;">
                    <canvas id="plansChart"></canvas>
                </div>
            </div>

            <!-- Income Line Chart -->
            <div class="col-md-6">
                <h3 class="mt-5 ms-5 mb-3" style="color: #1B4D3E">Income Trend</h3>
                <div style="height: 350px;">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <!-- Payment Method Pie Chart -->
            <div class="col-md-6">
                <h3 class="ms-4" style="color: #1B4D3E">Payment Method Distribution</h3>
                <div style="height: 300px;">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>`;

    // Ensure Chart.js only runs after elements are created
    setTimeout(() => {
        // Create Plans Distribution Chart
        new Chart(document.getElementById('plansChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: planCounts.map(item => item.category),
                datasets: [{
                    label: 'Number of Plans',
                    data: planCounts.map(item => item.count),
                    backgroundColor: '#bbd0ff',
                    borderColor: '#1B4D3E',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Create Income Line Chart
        new Chart(document.getElementById('incomeChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: incomeLabels,
                datasets: [{
                    label: 'Total Income (â‚¹)',
                    data: incomeValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: '#ff9800',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Create Payment Method Pie Chart (Fixed)
        const paymentCanvas = document.getElementById('paymentChart');
        if (paymentCanvas) {
            const ctx = paymentCanvas.getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(paymentMethods),
                    datasets: [{
                        label: 'Payments',
                        data: Object.values(paymentMethods),
                        backgroundColor: ['#4caf50', '#f44336', '#2196f3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } else {
            console.error("Payment chart canvas not found!");
        }
    }, 100);
}



        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'admin.html';
            }
        }

        // Utility functions
        function getExpiringUsers(days) {
            const today = new Date();
            const threeDaysFromNow = new Date(today);
            threeDaysFromNow.setDate(today.getDate() + days);

            return usersData.filter(user => {
                const expiryDate = new Date(user.expiry);
                return expiryDate <= threeDaysFromNow && expiryDate >= today;
            });
        }

        function getPlanDetails(planId) {
            for (const category in plansData) {
                const plan = plansData[category].find(p => p.plan_id === planId);
                if (plan) return plan.details;
            }
            return 'Plan not found';
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function calculateTotalRevenue() {
            return Object.values(plansData)
                .flat()
                .reduce((total, plan) => {
                    const amount = parseInt(plan.name.match(/â‚¹(\d+)/)[1]);
                    return total + amount;
                }, 0)
                .toLocaleString('en-IN');
        }
    </script>
</body>
</html>

